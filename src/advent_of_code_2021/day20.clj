(ns advent-of-code-2021.day20)
 
;; convets a binary number represented as a vector of 1s and 0s to an integer
(defn b2i [b]
  (reduce +
          (map * (reverse (map #(- % 48) (map int b))) (iterate (partial * 2) 1))))

(defn get-in-iea [dot-hash iea]
  (let [
        _ (println dot-hash)
        index (-> dot-hash
                  (clojure.string/replace #"\#" "1")
                  (clojure.string/replace #"\." "0")
                  (#(into [] %))
                  b2i)
        iea-parsed (->> iea
                        (into []))]
    (get iea-parsed index)))

(defn grow-image [image]
  (let [row-of-dots (repeat (count (first image)) \.)
        taller (into
                (into [row-of-dots] image)
                [row-of-dots])]
    (mapv #(conj (into [\.] %) \.) taller)))

(defn parse-image [image]
  (->> image
      (clojure.string/split-lines)
      (mapv #(into [] %))
       grow-image))

(defn enhance-pixel [image x y iea]
  (get-in-iea (str (get-in image [(dec y) (dec x)])
                   (get-in image [(dec y) x])
                   (get-in image [(dec y) (inc x)])
                   (get-in image [y (dec x)])
                   (get-in image [y x])
                   (get-in image [y (inc x)])
                   (get-in image [(inc y) (dec x)])
                   (get-in image [(inc y) x])
                   (get-in image [(inc y) (inc x)])) iea))

(defn enhance-image [processed-image iea]
  (loop [image (grow-image processed-image)
         new-image image
         x 1
         y 1]
    (if (and (= x (- (count (first image)) 2))
             (= y (- (count image) 2)))
      new-image
      (recur image
             (assoc-in new-image [y x] (enhance-pixel image x y iea))
             (if (= x (- (count (first image)) 2))
               1
               (inc x))
             (if (= x (- (count (first image)) 2))
               (inc y)
               y)))))

(defn enhance-times [processed-image iea times]
  (loop [image processed-image
         count 0]
    (if (= times count)
      image
      (do
        (println count)
        (recur (enhance-image image iea)
                 (inc count))))))

(defn count-hash [image iea times]
  (->> (enhance-times (parse-image image) iea times)
       (map (fn [row] (filter #(= \# %) row)))
       (map count)
       (apply +)))




(def test-iea  "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#")

(def test-image
"#..#.
#....
##..#
..#..
..###")

(def big-iea "#.#....########.......##..##.#.#####...#..#..##.###.##.#..##.....#.#....#...####.#...#.##.#.#.#....###...#.##.#...#.#....#...#.#..#....###.##.....#.######.#.##.#..####..#...#.##.##...#....###..#.##..###..#..#.....#.###.##....##...#....###.#.......#.#####...#.##..###....##.#.##..##.######...##..##.#..###.###.....###...##.##.#..#...##..#.###..#..###..##...#...#.#..#..#..##....###...........###.#....#######...#####.#..##...#..#....##.##.#.###...####...#.#..#...#.##.#.#..#.###.#.#####.#.##.###.##..#..#...###.#.")

(def big-image
".#.#.##.#######..#..#..#.#.#...###.###.##..##..##.###..#.#...##..##....##....#..####.#.###..#.#.#..#
#..###.##.........#..#.#...#......###..##.#.####....#..#..###.#.#######...###..#.#.##.#..##.#.#.....
.###..##.##..#.#.####.#.##..##.#.##.#..#####.#..#....#....#....#...#.##..###.#.####...##..##.##.#...
##....##....#.#.#...#..####..#..#.#.#.##.#.#.##..##.#..#...#..##...##...#.#.##.....##.####....#.....
#......#....#.###.##...#.#..#.#.#.##..###..##..###.##..##...####..#.#.#..##..#..#.#.#...###.......##
##.##...###.#.##..#######..#.###.###.##.....#.#...###..#####...#.###.#.#######.##....#.#.###..##..#.
..#.###....#.#.#..##..#.###.#.##.###.#..##.#...#...#......#####......###.##..#..##....#....#...#...#
#.##.##...#.#.#.#..##..#.#.##.#...#.###..#.####.##.#.#..#####...####..##..##..#.####.###..####.#..##
#####...#.####....##....##.........#.###.#...#..###.#........#.###.#...#.#.###########..#####..##...
..#.####..##.##.#..#.#####.##.#.#.#..######..####.#.#.#.##...#.#.#.#..##..###.###...#.....#.###...##
..#.....#.#.#..##..####.###.##.#.##.#.#...#.#####.#.#....##.#.#....##.#.##.#.##.##.#.#...#.....##.##
#..##....##...##...######.####.##....#..#.#.###.#.###..#.###......##.###....######.##.#...##...###..
##..#....###.##..#.#..########......##..#.#.##...#.##.#..#..#.##.###.#...#....#.##.#..#####.#..#.#.#
..#..#..######..#.##......#....#.#.#..#.##.##..##...#....###.##..#..###.##..##......##..#.#..###.##.
....#.####.##.#####.###.##..#.#####.###.....#.#..#########.##.##..###.##.#.#..#.....#####.###.#.#..#
...#..#.#.#.#.#.#######...#.#.####.##..##.....##..#####..#..#.##.#..##...#.##.##..#..........##.#.##
...#.###.##.####...##.###.#####.####.....##.#.##...#..#..###.###.#.........###.#####.....#.##..#.#..
.##.#.#.#.....#.#.##.#.#....#.###..####...#....##.#.#####.#...##...####..#...#######...####..#....##
##.#.###.#..###..###...####.#.###.####...#..#.##.......#...#.#........#..#..##.....#.##...###.#..#..
##.#.#..#........##..######.#######.######..##.#..##.#......#.###.#..#..##..###.........#.#######.#.
#.###.###...#.#.##.#########....#..#.#####.#.##.##..#..#.#.....##.#..###.#....###.###...#.#...##..#.
#.##.####..##....##...#.#...#.##.#..##.###..##..#####.#...#.#.......#..#.###....#..#..##.....#.###..
#.###.#.#.#...##..#.#.##...###..#.##........#.##.####.#..####.#.#.###.##....#.##.######.####.###....
.####...#..#..#.#..####..##..#.#.....##.#..##...#.#.#.#...##....#......##...#..#.###.#...##..#.####.
..####...#.#....###..#.#..#....##..#..#.#..####.#.##..##.###...##..#..#######.#.#######......####...
#.#..#..###.#.##.###..###.##.#.###.#####.#..#.#####.#.##.#..#.########..###..#...#.###..##..#.#..###
######...#....#....#......#......#.##.######...#.......#..#..##..#..##.#..#..####..##....##.##..#.#.
#....###.#.######.###..##.#..###..#..#..###.#.....#.#.##..###..#.#..##.###.#..#..#.#.#..##.##.#.####
#..#..#####.##...##.#..#######.#.#.#..###.#.##.###..#....####...####..##..##..#...#...#..#..#.#..#..
...#....##...####.#.##.#.#.#.......#..##....###.##..#...##...##.#.#.#.#.###..###..##..#.....##....##
#.#.#######..###...###.##.#..#..###.#####.###.#.#..##...#.##..####...##..#.##...#.##.#####.##.......
.#...#......##..#.#.##...###.##.#.##....####.##.#####.##.#..#.#..##....#.#.#..######....#.###.#####.
#..#.##..###..#.##.#....##..#.#..#..##..##...#...####..........#...#...###.#.#..#...#..###.##.#.##..
...#...#.#...#..#.#.###.#.#.#.#..##..##.#######...#.######....#.#.###.#.#.##.#.#.###.###.##.###..###
#.##....#.#.....#..###..#####.#..#..##.###....#.###....#.#####.###.#.######.....#..#.#..###..#.....#
....#..#..#.#.....#####.....###.....##.##.#..##....#...#...###...#..##..#..#####..##.#.#..#.#...####
#.#####...#.##..#..##..#.##.#..##........#...#....#.#....###.#.#...##.##.#####..###..##.#.#.#.#.####
#.###.####.#...#..##########..#.###..#.#.###...#.##..#####.###..#..###....##.##...#..###.##.#..#.##.
##.######.###.#...##..###.#.#.#.###.#.##....####..#.#.###.#...#..##.#####...##..###.#..##..####.....
#.#.....##...#.###.#.###.#.##.#.###....#.##.....##....####.####.##.#...#.....#..#####..#.#....###.##
###..##.#....####.#####.#.#..#..#....###.###.#..####.#.####..###.#.#...###.##........#.#####.#.##..#
##.#.###.###.......###.#.##.#..#.##.####.###....#..#.#.#...##....##..#....###.#####..###...##.#.##..
.#..###.#...#...#..#..##...##.#...#######...#..#.##..####..##...##.##.##.###.####...##.....#...#.###
#.##.........##..#..###..#....#.###..##..#.##.....##.###.....##..#.#.#######...#...#.....#..##..#..#
##..#.###.#...#.##...#.#..###.##...#...#####.####...###.#..##.##..#.##.#.#..#####.#...##..####...#..
..#.#.........#####.##..###.#.#.#..#.##...##.#..##.#..####.##.#.###.#.#.###.##...#.##....#.#######.#
###..#..#.#.#...#.###.#####.#.#.######.....##.#.##.#.#...#..#.#.##..###.#..###.####...##..####......
#..#..#.#....###.#.##..#.#.#.#.##..#..##.......#..#.#.......##...####.#.#..###...........#...#.#.#.#
#....##..##..#.##...###.#..#.#####.#.#.###.#.#..######.....#.#####....#.#..####..#.##.#####..#...#..
.##.###..##......###.....#.#.##...#..####.#..#...#..###.####.#..####.#...#.######.#.#..#####.....##.
#...###.###...##.#####..###.###.#####.###.#..###.#..#######..#..#####....#..##...######...##.#....##
###.#.#.#.#####..#####.#..##.#.###...####.#.#.#..#.#......#...#....#...#.#..#..#...#...##..#..##..##
.####....##..##.###..#.######...#.#..#.##..#..##.###.#.##.#...###.#.#.#....#.####.#.#....##.#####..#
##..##...###.#.#.#####..#.##..#####.####.##.#..#..####..#..##.##..###..###.....#.#.#.#####...#.###.#
###.####.##....#.##.#....#..###..##.##..#.....#.###....#.######...##.....#.##.##..###.####.#.###.#.#
#.#....#.#.#.#.#..##.##.##..##..##..####.#.#.#..##.#####..#####...#.#..##....#######.###..##..######
.#.....#.#..####.###..###...###.##....#.#.#.#..##.##...##..#.########..#.#...#..#.#..#.##.#.#.###.#.
#..#.####..####.##..##.##..#..##.####..#..##...#.##..#..#.###.#....#####..##.#######.#.###..#.#....#
.##.#....####....#.##.###..#..#..###.#.#.##.#..##.###....#######.####..#.########.#.....##.#...##..#
#.###..#.#.........#.#.#....########.####..###......##..#.##.#.#..######.#.###..#...####...##.##.#..
#.###.#..###...##.#......##..#..##.#..###..#.####...#.#..#...#.#####..##.###..##.##.#.#...#.#...#.##
##.###..#..#.#.##.##.##...###..#..#.#.#..#...###..#.#...#..#####.####...########.#...#.#.#.###.##...
.#####..#..#..####.#..#.....##.##....###...##.####.#.####.#..#####..#.#..#.##.###.#..##..###..#..#..
.#.#....#.####.#.###.#.###.####.#.##.#......##...#...#..###.###.#..##...#.#.#..##.##.#####.##.###..#
.##..###.##..#####.##.#....###...##....##..###.##.########.#.....#..##..#...#.#.#.###..#...#.#.#...#
#.####...####.###.#.#.###.###.#####.#...###.####..#..#..####.###..#.#..#.##.###..#.......#.#..##.#..
...#.###....#...###.#.###.#.#.#...#.##......#..###..###.#.#.#..###.##..#.#.#..#..##..#.#..###.##.#.#
#..#....#..####....####...#..######.#.#..##.#.##.###.#.#..##.#.....###..#....##......##.####..#.#..#
##..##......#..##..#..##.##.##..#..#.#...####.#.##...##.#.##.#..#...##..##.##..#..####..#..#..#..##.
#.####.#######.....##.#..##....#..#.#......###..##.##..##..#.#.#.#..##..#.#.....#......#.#.#.#....#.
....##.###...#...###..#..#.##...#.#.#.##...##....####..#..##..#.##.##...##..##....#...###.#.##....#.
..#..###.#.###.#.#.#...####...###.#..#.#.#...#.#.......##..#....##..#.##.##..##..#..####.#.#.......#
##.##.##.#....#.#..###.####..##..#..######..#.###.###.#####......#.#...#.#.....#####...#....#.###...
.#...##.##.#..#.##..###..#.######...#..#....#.#....#..###....#.#.#.##...#####.#..#...#..#..###......
.#......####....#.#...#.#.##.###.#..#..####.#...####..#####.##.#...#.#.#.##.##...#.#.#.##.#.##...###
..###..#####.#....##..#..#.###...#..##..##.#......#..####.#.###.#...#....###.#.##..####.#.####.###..
..##..#.#.#.#.##.####...#..#..#..#.##..#...##.#.##.#.###.###.#.#.##...#.#######.#.#.....####........
##.###.#.#.#..#..##..##.##.##.###...#...##..#.##.....#.#..#.##.#.#.###...##.####..##..##..#.#....#..
..#.##.#.##.###...###..#..#...##....#..#......####.##...#####...#...#.####.##.###.....#..#.#..##.##.
#..######.#.#..##...##.#.#..##...##.####.#######..#..#..###.##..#..#...#....#..#.##....###...#.#.##.
..#.#.#....####.#.#.........#..#.#..##..####...#.####...#..#.#...###.####..##......#..#...#.##.##.#.
.####.##..##.####..#.#.##..####.#.#......##.##...####.####.#..#...##.#..######.#.##.#.##.##.#.#.##.#
.#....##...#..###..#.#..#.##..#.####.#..###..##..#####..#..#.#.##..#.....#..###.....###.#.##.#.##.#.
...##...#...#..#..........#######......##.##.#.##.##.#..#.##.###.###..#..#....##..#.###.#..#...#####
.#####...#.##.....####.###.#.#..#....#...##..#....###.#.##.##########.#.#...#.####.......#..#...#.#.
.#....#.####.##.#.###..#.###.#....#.###..##...###...#.....###..####...#..##.#..##.#....###.#....#.#.
.##..###........#.#.##..##.##.##..#..####.#.#.##.##.#..#.#..#######.....######.#.#..#..###....#.##.#
..#.##..#...##.######..#..##.###...#.#.####..####..#.#...#.....##...##.#..##.#..#..#.###.##..#.#....
..#.###.###.#..#####....#...#..#...#..#.##..##..#.####..#..#.##.#.##..#######...##.#.#.#..#.##..###.
###.##..#..#...#####.#....#.#...#..###..##...##...#...#...#.###.#..#..#########..##.....#....#.#...#
#..##.#....#..####..###.#.#.#.##.###.#..#.###.##....##.#.#..#..#.#.#..###..##.#.#.#..#..#.#.###..###
#.#.#.###..#.#.#.....###.#.#....#.#####....##.###.##....#.......#..###.#.#..###..####.#.....####....
#####.####.#.#..#####.#.#....#....#......####.####.#.###.##..#...#.#..##.##.#########.###.#.#.#.#.##
.....#.##.##.#####...#.##...#...##########.###....##..####...#..####.##..###.#.#######.##...##.###..
#.#..##..#..##...........####.#....##.##.#..#.##..####.#..#.#..#...#...###.###.#...##.#.#.##.#..###.
.#####.#.#.#######.##..#..#..#..###.###.#..####..#.##....#.#..#.##.##.##.#########......####..#.##.#
.#....###..#.###.##.#...#.#...#...#.####...#.......#..###..####.####..#.####.##.#.##...###.###....#.
##......##.....#####.#.#.#......#.#.#.#.###.######.....#.##.#..#.#######.###.########..####..#.###.#
###.##....###..#.#####..#..####..#.......##.##.#.##.#.#.#.#..#......####..###..####.##.#.......#.#.#
#..###.###..#..##.#####.##.#....##.###.###....#######.#...#.#.#.#..#######...#.....#..##.####.###.##")